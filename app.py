import streamlit as st
import openai
import PyPDF2

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ë—Ä–µ–Ω–¥–∏–Ω–≥)
st.set_page_config(
    page_title="JurisClear AI | –£–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–æ–≤",
    page_icon="‚öñÔ∏è",
    layout="wide"
)

# –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Markdown (–¥–µ–ª–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–∏—â–µ)
st.markdown("""
    <style>
    .main {
        background-color: #f8f9fa;
    }
    .stButton>button {
        width: 100%;
        border-radius: 5px;
        height: 3em;
        background-color: #007BFF;
        color: white;
    }
    .risk-box {
        padding: 20px;
        border-radius: 10px;
        border-left: 5px solid #ff4b4b;
        background-color: #fff1f1;
        margin-bottom: 10px;
    }
    </style>
    """, unsafe_allow_html=True)

# –®–∞–ø–∫–∞ —Å–∞–π—Ç–∞
col1, col2 = st.columns([2, 1])

with col1:
    st.title("‚öñÔ∏è JurisClear AI")
    st.subheader("–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—É–¥–∏—Ç –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –∑–∞ 30 —Å–µ–∫—É–Ω–¥")
    st.write("""
        –ù–∞—à –ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –Ω–∞—Ö–æ–¥–∏—Ç —Å–∫—Ä—ã—Ç—ã–µ —Ä–∏—Å–∫–∏ 
        –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç '—é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∂–∞—Ä–≥–æ–Ω' –Ω–∞ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π —è–∑—ã–∫. 
        **–ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF –∏ –ø–æ–ª—É—á–∏—Ç–µ –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç.**
    """)

with col2:
    st.info("üí° **–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?**\n90% –ª—é–¥–µ–π –ø–æ–¥–ø–∏—Å—ã–≤–∞—é—Ç –¥–æ–≥–æ–≤–æ—Ä—ã, –Ω–µ —á–∏—Ç–∞—è –º–µ–ª–∫–∏–π —à—Ä–∏—Ñ—Ç. –ú—ã –Ω–∞—Ö–æ–¥–∏–º —Å–∫—Ä—ã—Ç—ã–µ —à—Ç—Ä–∞—Ñ—ã –∏ –ª–æ–≤—É—à–∫–∏.")

st.divider()

# –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å (–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –û–ø–ª–∞—Ç–∞)
with st.sidebar:
    st.header("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏–∑–∞")
    api_key = st.text_input("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à API Key", type="password", help="–ö–ª—é—á –æ—Ç OpenAI –¥–ª—è —Ä–∞–±–æ—Ç—ã –º–æ–∑–≥–∞ —Å–∏—Å—Ç–µ–º—ã")
    
    st.divider()
    st.header("–¢–∞—Ä–∏—Ñ—ã")
    st.write("üîì **–ü—Ä–æ–±–Ω—ã–π:** 1 –∞–Ω–∞–ª–∏–∑ –±–µ—Å–ø–ª–∞—Ç–Ω–æ")
    st.write("üíé **Pro:** $29/–º–µ—Å (–ë–µ–∑–ª–∏–º–∏—Ç)")
    if st.button("–ö—É–ø–∏—Ç—å Pro –≤–µ—Ä—Å–∏—é"):
        st.write("üí≥ –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è...")

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
uploaded_file = st.file_uploader("–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –¥–æ–≥–æ–≤–æ—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF", type="pdf")

if uploaded_file is not None:
    if not api_key:
        st.error("‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à API Key –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑.")
    else:
        # –ß–∏—Ç–∞–µ–º PDF
        pdf_reader = PyPDF2.PdfReader(uploaded_file)
        text = ""
        for page in pdf_reader.pages:
            text += page.extract_text()

        if st.button("–ó–ê–ü–£–°–¢–ò–¢–¨ –Æ–†–ò–î–ò–ß–ï–°–ö–ò–ô –ê–£–î–ò–¢"):
            openai.api_key = api_key
            
            with st.status("–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ 50+ –∫—Ä–∏—Ç–µ—Ä–∏—è–º —Ä–∏—Å–∫–∞...", expanded=True) as status:
                st.write("üîç –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞...")
                st.write("‚öñÔ∏è –°–≤–µ—Ä–∫–∞ —Å –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å–Ω–æ–π –±–∞–∑–æ–π...")
                
                # –ü—Ä–æ–º–ø—Ç (–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ò–ò)
                prompt = f"""
                –¢—ã - —Å—Ç–∞—Ä—à–∏–π —é—Ä–∏—Å—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ —Å–æ—Å—Ç–∞–≤—å –æ—Ç—á–µ—Ç –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–ª–∞–Ω—É:
                1. –°–£–¢–¨: –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
                2. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –†–ò–°–ö–ò (–ö—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏): –ù–∞–π–¥–∏ —Å–∫—Ä—ã—Ç—ã–µ —à—Ç—Ä–∞—Ñ—ã, –Ω–µ–≤—ã–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏—è –∏–ª–∏ –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏.
                3. –ü–†–ê–í–ö–ò: –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ —Ç–µ–∫—Å—Ç–µ, —á—Ç–æ–±—ã –∑–∞—â–∏—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞.
                4. –°–õ–û–ñ–ù–´–ï –¢–ï–†–ú–ò–ù–´: –û–±—ä—è—Å–Ω–∏ 3 —Å–∞–º—ã—Ö —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–∞ –∏–∑ —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.
                
                –¢–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞:
                {text[:4000]} 
                """
                # (text[:4000] - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –≤—ã–π—Ç–∏ –∑–∞ –ª–∏–º–∏—Ç—ã –Ω–∞ —Å—Ç–∞—Ä—Ç–µ)

                try:
                    response = openai.chat.completions.create(
                        model="gpt-4o",
                        messages=[{"role": "system", "content": "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —é—Ä–∏—Å—Ç-–∞—É–¥–∏—Ç–æ—Ä."},
                                  {"role": "user", "content": prompt}]
                    )
                    analysis = response.choices[0].message.content
                    status.update(label="–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!", state="complete", expanded=False)
                    
                    st.markdown("### üìã –û—Ç—á–µ—Ç –æ–± –∞—É–¥–∏—Ç–µ")
                    st.markdown(analysis)
                    
                    # –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                    st.download_button("–°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç –≤ .txt", analysis, file_name="audit_report.txt")
                    
                except Exception as e:
                    st.error(f"–û—à–∏–±–∫–∞ API: {e}")

# –§—É—Ç–µ—Ä
st.divider()
st.caption("JurisClear AI ¬© 2026. –î–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∑–∞–º–µ–Ω–æ–π –æ—á–Ω–æ–π —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.")
